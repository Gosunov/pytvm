import asyncio
import time

from pytvm.transaction_emulator import TransactionEmulator
from pytoniq import LiteClient, MessageAny
from pytoniq_core import Cell


async def get_account_state():
    client = LiteClient.from_mainnet_config(5, 2)
    await client.connect()

    # get old state
    blk, _ = await client.lookup_block(-1, -2**63, utime=int(time.time()) - 1000000)
    acc_st, sh = await client.raw_get_account_state('UQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHZH9', blk)
    return sh


state = asyncio.run(get_account_state())
print(state)
emulator = TransactionEmulator()
emulator.set_unixtime(int(time.time()) - 1000000)

boc_with_message = 'b5ee9c72010204010001500003e588011e132a6fdfcd0544c797034802e1d23d7cfc63c8c48e93ecd82dbd3c2fa1d23a04e33adc9d26c9ade4fbc96a700d8ed1895ad52149bd8557a9009892e033aaf3438fecd526f05c6d6dc9e5ccccc50273f82a9c49975b6819bb50c2b27dab7ac8714d4d18bb2eeb6008000002300018181c010203008c42004784ca9bf7f3415131e5c0d200b8748f5f3f18f23123a4fb360b6f4f0be8748ea017d78400000000000000000000000000000000000074657374206f7665726c61792033008c42004784ca9bf7f3415131e5c0d200b8748f5f3f18f23123a4fb360b6f4f0be8748ea01c9c3800000000000000000000000000000000000074657374206f7665726c61792033008c42004784ca9bf7f3415131e5c0d200b8748f5f3f18f23123a4fb360b6f4f0be8748ea02160ec00000000000000000000000000000000000074657374206f7665726c61792033'

result = emulator.emulate_transaction(state.cell, Cell.one_from_boc(boc_with_message))
print(result)
# {'success': True, 'transaction': < Tl-B Transaction account_addr: b'\x8f\t\x957\xef\xe6\x82\xa2c\xcb\x81\xa4\x01p\xe9\x1e\xbe~1\xe4bGI\xf6l\x16\xde\x9e\x17\xd0\xe9\x1d' account_addr_hex: '8f099537efe682a263cb81a40170e91ebe7e31e4624749f66c16de9e17d0e91d' lt: 44553158000000 prev_trans_hash: b"hv\xbe\xbaX\xb2\x0ez's\xc8\xeb\x8b\x00\x19d9\xfd\xb5r\x90\x9b\x87S3VH?1\xa1\xc8\x9b" prev_trans_lt: 44553157000005 now: 1708362585 outmsg_cnt: 3 orig_status: < Tl-B AccountStatus type_: 'active' > end_status: < Tl-B AccountStatus type_: 'active' > in_msg: < Tl-B MessageAny info: < Tl-B ExternalMsgInfo src: None dest: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> import_fee: 0 > init: None body: <Cell 640[9C675B93A4D935BC9F792D4E01B1DA312B5AA42937B0AAF52013125C06755E6871FD9AA4DE0B8DADB93CB99998A04E7F05538932EB6D03376A18564FB56F590E29A9A31765DD6C010000004600030303] -> 3 refs> > out_msgs: [< Tl-B MessageAny info: < Tl-B InternalMsgInfo ihr_disabled: True bounce: False bounced: False src: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> dest: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> value: < Tl-B CurrencyCollection grams: 50000000 other: < Tl-B ExtraCurrencyCollection dict: None > > value_coins: 50000000 ihr_fee: 0 fwd_fee: 666672 created_lt: 44553158000001 created_at: 1708362585 > init: None body: <Cell 144[0000000074657374206F7665726C61792033] -> 0 refs> >, < Tl-B MessageAny info: < Tl-B InternalMsgInfo ihr_disabled: True bounce: False bounced: False src: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> dest: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> value: < Tl-B CurrencyCollection grams: 60000000 other: < Tl-B ExtraCurrencyCollection dict: None > > value_coins: 60000000 ihr_fee: 0 fwd_fee: 666672 created_lt: 44553158000002 created_at: 1708362585 > init: None body: <Cell 144[0000000074657374206F7665726C61792033] -> 0 refs> >, < Tl-B MessageAny info: < Tl-B InternalMsgInfo ihr_disabled: True bounce: False bounced: False src: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> dest: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> value: < Tl-B CurrencyCollection grams: 70000000 other: < Tl-B ExtraCurrencyCollection dict: None > > value_coins: 70000000 ihr_fee: 0 fwd_fee: 666672 created_lt: 44553158000003 created_at: 1708362585 > init: None body: <Cell 144[0000000074657374206F7665726C61792033] -> 0 refs> >] total_fees: < Tl-B CurrencyCollection grams: 8733758 other: < Tl-B ExtraCurrencyCollection dict: None > > state_update: < Tl-B HashUpdate old_hash: b"\xcb\x0fl\xb1D\xc2v\x92A\xaf=y\x18I\x98/\xd3\xf8{\xb4*\x9b\xcco\xfe'\xa6\xed\xda190" new_hash: b'\x13\x82\xbd\xfa\x89#Fo\x1b\x0f\xf6w\xe4z\xe2/\x88\x89j\x8d\xea\xee(Q\xef\x98^\xc3\xd4\x80\x88\xb4' > description: < Tl-B TransactionOrdinary type_: 'ordinary' credit_first: True storage_ph: < Tl-B TrStoragePhase storage_fees_collected: 161774 storage_fees_due: None status_change: < Tl-B AccStatusChange type_: 'unchanged' > > credit_ph: None compute_ph: < Tl-B TrComputePhase type_: 'vm' success: True msg_state_used: False account_activated: False gas_fees: 4592000 gas_used: 4592 gas_limit: None gas_credit: 10000 mode: 0 exit_code: 0 exit_arg: None vm_steps: 84 vm_init_state_hash: b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' vm_final_state_hash: b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00' > action: < Tl-B TrActionPhase success: True valid: True no_funds: False status_change: < Tl-B AccStatusChange type_: 'unchanged' > total_fwd_fees: 3000000 total_action_fees: 999984 result_code: 0 result_arg: None tot_actions: 3 spec_actions: 0 skipped_actions: 0 msgs_created: 3 action_list_hash: b'7\x1a\\\xf3\x19L\x16x\xbd\x83\xee\xa3\x10\xf4\x90\xaa\xc5\xedJ\xa5r\x18E\x07/\xed\xb5\xd3(0\x11d' tot_msg_size: < Tl-B StorageUsedShort cells: 3 bits: 2547 > > aborted: False bounce: None destroyed: False > cell: <Cell 724[78F099537EFE682A263CB81A40170E91EBE7E31E4624749F66C16DE9E17D0E91D000028855727FD806876BEBA58B20E7A2773C8EB8B00196439FDB572909B87533356483F31A1C89B000028855718BB4565D38B590007470A887C0] -> 3 refs> >, 'shard_account': < Tl-B ShardAccount account: < Tl-B Account addr: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> storage_stat: < Tl-B StorageInfo used: < Tl-B StorageUsed cells: 22 bits: 5689 public_cells: None > last_paid: 1708362585 due_payment: None > storage: < Tl-B AccountStorage last_trans_lt: 44553158000004 balance: < Tl-B CurrencyCollection grams: 522084466 other: < Tl-B ExtraCurrencyCollection dict: None > > state: < Tl-B AccountState type_: 'account_active' state_init: < Tl-B StateInit split_depth: None special: None code: <Cell 80[FF00F4A413F4BCF2C80B] -> 1 refs> data: <Cell 321[0000004729A9A31722F1D146DCC2A181F593205CFDCC7F1B845C15947DFE7EE1A9152175F096F89400] -> 0 refs> library: None > > > > last_trans_hash: b'\xef\x8d\x8d\xceF\x8c\x8b"z\xbf\xad\x97\n\xc4\x85\x7f\xd1Y\xd8\xf1\x7f6\xf1_q\x06\x99\xc0\x0e\xb3zx' last_trans_lt: 44553158000000 cell: <Cell 320[EF8D8DCE468C8B227ABFAD970AC4857FD159D8F17F36F15F710699C00EB37A78000028855727FD80] -> 1 refs> >, 'vm_log': 'ute LDU 8\nexecute LDREF\nexecute XCHG s2\nexecute SENDRAWMSG\ninstalling an output action\nexecute implicit RET\nwhile loop body end\nexecute DUP\nexecute SREFS\nexecute implicit RET\nwhile loop condition end\nwhile loop terminated\nexecute DROP\nexecute implicit RET\n', 'actions': [< Tl-B OutAction type_: 'action_send_msg' mode: 3 out_msg: < Tl-B MessageAny info: < Tl-B InternalMsgInfo ihr_disabled: True bounce: False bounced: False src: None dest: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> value: < Tl-B CurrencyCollection grams: 50000000 other: < Tl-B ExtraCurrencyCollection dict: None > > value_coins: 50000000 ihr_fee: 0 fwd_fee: 0 created_lt: 0 created_at: 0 > init: None body: <Cell 144[0000000074657374206F7665726C61792033] -> 0 refs> > new_code: None currency: None libref: None >, < Tl-B OutAction type_: 'action_send_msg' mode: 3 out_msg: < Tl-B MessageAny info: < Tl-B InternalMsgInfo ihr_disabled: True bounce: False bounced: False src: None dest: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> value: < Tl-B CurrencyCollection grams: 60000000 other: < Tl-B ExtraCurrencyCollection dict: None > > value_coins: 60000000 ihr_fee: 0 fwd_fee: 0 created_lt: 0 created_at: 0 > init: None body: <Cell 144[0000000074657374206F7665726C61792033] -> 0 refs> > new_code: None currency: None libref: None >, < Tl-B OutAction type_: 'action_send_msg' mode: 3 out_msg: < Tl-B MessageAny info: < Tl-B InternalMsgInfo ihr_disabled: True bounce: False bounced: False src: None dest: Address<EQCPCZU37-aComPLgaQBcOkevn4x5GJHSfZsFt6eF9DpHcw4> value: < Tl-B CurrencyCollection grams: 70000000 other: < Tl-B ExtraCurrencyCollection dict: None > > value_coins: 70000000 ihr_fee: 0 fwd_fee: 0 created_lt: 0 created_at: 0 > init: None body: <Cell 144[0000000074657374206F7665726C61792033] -> 0 refs> > new_code: None currency: None libref: None >], 'elapsed_time': 0.001425}
